<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Goklat 945 - Order Online</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
    
    * { font-family: 'Poppins', sans-serif; box-sizing: border-box; }
    
    .product-card { transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; }
    .product-card:hover:not(.disabled) { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2); }
    
    .whatsapp-btn {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      transition: all 0.3s ease;
    }
    .whatsapp-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(37, 211, 102, 0.4); }
    
    .category-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }
    .category-content.open { max-height: 5000px; }
    
    .rotate-icon { transition: transform 0.3s ease; }
    .rotate-icon.open { transform: rotate(180deg); }

    .sold-out-badge {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-15deg);
      background: rgba(239, 68, 68, 0.9);
      color: white;
      padding: 4px 12px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 10;
      pointer-events: none;
    }

    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #5b21b6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 h-full w-full overflow-auto">
  <div id="app" class="w-full min-h-full">
    <!-- Indikator Loading Awal -->
    <div class="flex flex-col items-center justify-center h-screen">
      <div class="loader mb-4"></div>
      <p class="text-purple-900 font-semibold">Memuat Menu Goklat...</p>
    </div>
  </div>

  <script>
    const config = {
      store_title: "Goklat 945",
      store_address: "Batang Ayumi Julu, Padang Sidempuan Utara",
      whatsapp_number: "6282277647548",
      primary_color: "#5b21b6"
    };

    const locationData = {
      "Padangsidimpuan Utara": { "Batang Ayumi Julu": 2000, "Batang Ayumi Jae": 2000, "Baringin": 3000, "Bonan Dolok": 3000, "Kantor": 3000, "Losung Batu": 3000, "Pancuran Gerobak": 3000, "Sadabuan": 5000, "Sibatua": 5000, "Timbangan": 5000, "Wek I": 3000, "Wek II": 3000, "Wek III": 3000, "Wek IV": 3000 },
      "Padangsidimpuan Selatan": { "Aek Tampang": 5000, "Hanopan": 5000, "Losung": 5000, "Padang Matinggi": 5000, "Padang Matinggi Lestari": 5000, "Sidangkal": 5000, "Sihitang": 8000, "Sitinjak": 8000, "Ujung Padang": 5000, "Wek V": 3000, "Wek VI": 3000 },
      "Padangsidimpuan Tenggara": { "Labuhan Labo": 8000, "Labuhan Rasoki": 10000, "Manunggang Jae": 8000, "Manunggang Julu": 8000, "Palopat Maria": 8000, "Purbatua Pijor Koling": 10000, "Sihitang Jae": 8000, "Pijor Koling": 10000 },
      "Padangsidimpuan Batunadua": { "Batunadua Jae": 8000, "Batunadua Julu": 8000, "Batu Gajah": 8000, "Pudun Jae": 8000, "Pudun Julu": 8000, "Siloting": 10000, "Simirik": 8000, "Ujung Gurap": 8000 },
      "Padangsidimpuan Hutaimbaru": { "Hutaimbaru": 8000, "Lembah Lubuk Raya": 10000, "Sabungan Sipabangun": 10000, "Singali": 10000, "Talippung": 10000 },
      "Padangsidimpuan Angkola Julu": { "Batuayan": 12000, "Joring Lombang": 12000, "Joring Natobang": 12000, "Mombang": 12000, "Pintu Langit Jae": 12000, "Simasom": 12000 }
    };

    let categories = {};
    let cart = [];
    let openCategories = {};
    let selectedKecamatan = "";
    let selectedKelurahan = "";
    let currentShippingFee = 0;

    // Fungsi Utama Fetch Data dari products.json
    async function loadProducts() {
      try {
        const response = await fetch('products.json');
        if (!response.ok) throw new Error('Gagal memuat file products.json');
        
        categories = await response.json();
        
        // Inisialisasi status kategori (tutup semua kecuali yang pertama secara default)
        Object.keys(categories).forEach((key, index) => {
          openCategories[key] = index === 0;
        });
        
        renderApp();
      } catch (error) {
        console.error("Fetch error:", error);
        document.getElementById('app').innerHTML = `
          <div class="flex flex-col items-center justify-center h-screen p-6 text-center">
            <p class="text-red-600 font-bold mb-2">Oops! Gagal Memuat Data</p>
            <p class="text-gray-500 text-sm">Pastikan file 'products.json' berada di folder yang sama atau sudah di-upload ke GitHub.</p>
            <button onclick="location.reload()" class="mt-4 px-6 py-2 bg-purple-600 text-white rounded-lg">Coba Lagi</button>
          </div>
        `;
      }
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    }

    function toggleCategory(key) {
      openCategories[key] = !openCategories[key];
      renderApp();
    }

    function addToCart(pid) {
      let product = null;
      for (let k in categories) {
        let found = categories[k].products.find(p => p.id === pid);
        if (found) { product = found; break; }
      }
      if (!product || product.outOfStock) return;
      
      const item = cart.find(i => i.id === pid);
      if (item) {
        item.qty++;
      } else {
        cart.push({ ...product, qty: 1 });
      }
      renderApp();
    }

    function updateQty(pid, delta) {
      const item = cart.find(i => i.id === pid);
      if (item) {
        item.qty += delta;
        if (item.qty <= 0) cart = cart.filter(i => i.id !== pid);
      }
      renderApp();
    }

    function handleLocationChange(kec, kel) {
      selectedKecamatan = kec;
      selectedKelurahan = kel;
      currentShippingFee = (kec && kel) ? locationData[kec][kel] : 0;
      renderApp();
    }

    function sendToWhatsApp(e) {
      e.preventDefault();
      const f = e.target;
      const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
      const total = subtotal + currentShippingFee;

      let msg = `*PESANAN BARU - ${config.store_title}*\n\n`;
      cart.forEach(i => msg += `â€¢ ${i.name} (x${i.qty}) - ${formatCurrency(i.price * i.qty)}\n`);
      msg += `\n*Subtotal:* ${formatCurrency(subtotal)}`;
      msg += `\n*Ongkir:* ${formatCurrency(currentShippingFee)}`;
      msg += `\n*Total Bayar:* ${formatCurrency(total)}\n\n`;
      msg += `*Detail Pengiriman:*\nNama: ${f.name.value}\nAlamat: ${f.address.value}\nLokasi: ${selectedKelurahan}, ${selectedKecamatan}`;
      
      window.open(`https://wa.me/${config.whatsapp_number}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function renderApp() {
      const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
      const total = subtotal + currentShippingFee;

      document.getElementById('app').innerHTML = `
        <div class="max-w-4xl mx-auto px-4 py-8">
          <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-purple-900 mb-2">${config.store_title}</h1>
            <p class="text-gray-600">${config.store_address}</p>
          </header>

          <div class="space-y-6">
            ${Object.keys(categories).map(key => {
              const cat = categories[key];
              const isOpen = openCategories[key];
              return `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                  <div onclick="toggleCategory('${key}')" class="p-5 bg-purple-50 flex justify-between items-center cursor-pointer">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">${cat.icon}</span>
                      <h2 class="text-xl font-bold text-purple-900">${cat.name}</h2>
                    </div>
                    <svg class="rotate-icon ${isOpen ? 'open' : ''}" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                  </div>
                  <div class="category-content ${isOpen ? 'open' : ''} p-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${cat.products.map(p => {
                      const inCart = cart.find(i => i.id === p.id);
                      return `
                        <div class="product-card border rounded-xl p-3 text-center ${p.outOfStock ? 'opacity-50' : ''}">
                          ${p.outOfStock ? `<div class="sold-out-badge">HABIS</div>` : ''}
                          <img src="${p.image}" class="w-full h-32 object-contain mb-2 rounded-lg" onerror="this.src='https://placehold.co/200x200?text=Menu'">
                          <h3 class="text-xs font-bold h-8 overflow-hidden mb-1">${p.name}</h3>
                          <p class="text-purple-700 font-bold text-sm mb-3">${formatCurrency(p.price)}</p>
                          ${p.outOfStock ? 
                            `<button disabled class="w-full py-2 bg-gray-200 text-gray-500 rounded-lg text-xs font-bold">Stok Habis</button>` :
                            (inCart ? 
                              `<div class="flex items-center justify-between bg-purple-100 rounded-lg p-1">
                                <button onclick="updateQty(${p.id}, -1)" class="w-7 h-7 bg-purple-600 text-white rounded font-bold">-</button>
                                <span class="font-bold text-purple-900">${inCart.qty}</span>
                                <button onclick="updateQty(${p.id}, 1)" class="w-7 h-7 bg-purple-600 text-white rounded font-bold">+</button>
                              </div>` :
                              `<button onclick="addToCart(${p.id})" class="w-full py-2 bg-purple-600 text-white rounded-lg text-xs font-bold">Tambah</button>`
                            )
                          }
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              `;
            }).join('')}
          </div>

          ${cart.length > 0 ? `
            <div class="mt-10 bg-white p-6 rounded-3xl shadow-xl border-t-4 border-purple-600">
              <h3 class="text-xl font-bold mb-4">ðŸ›’ Ringkasan Pesanan</h3>
              <div class="space-y-3 mb-6 border-b pb-6">
                ${cart.map(i => `
                  <div class="flex justify-between items-center text-sm">
                    <span>${i.name} (x${i.qty})</span>
                    <span class="font-bold">${formatCurrency(i.price * i.qty)}</span>
                  </div>
                `).join('')}
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                  <label class="text-xs text-gray-500 mb-1 block">Pilih Kecamatan</label>
                  <select onchange="handleLocationChange(this.value, '')" class="w-full p-3 border rounded-xl bg-gray-50 outline-none">
                    <option value="">-- Pilih Kecamatan --</option>
                    ${Object.keys(locationData).map(k => `<option value="${k}" ${selectedKecamatan === k ? 'selected' : ''}>${k}</option>`).join('')}
                  </select>
                </div>
                <div>
                  <label class="text-xs text-gray-500 mb-1 block">Pilih Kelurahan</label>
                  <select onchange="handleLocationChange(selectedKecamatan, this.value)" ${!selectedKecamatan ? 'disabled' : ''} class="w-full p-3 border rounded-xl bg-gray-50 outline-none">
                    <option value="">-- Pilih Kelurahan --</option>
                    ${selectedKecamatan ? Object.keys(locationData[selectedKecamatan]).map(kel => `<option value="${kel}" ${selectedKelurahan === kel ? 'selected' : ''}>${kel}</option>`).join('') : ''}
                  </select>
                </div>
              </div>

              <div class="bg-purple-50 p-4 rounded-2xl mb-6 space-y-2">
                <div class="flex justify-between text-sm"><span>Subtotal</span><span>${formatCurrency(subtotal)}</span></div>
                <div class="flex justify-between text-sm"><span>Ongkos Kirim</span><span>${formatCurrency(currentShippingFee)}</span></div>
                <div class="flex justify-between font-bold text-lg pt-2 border-t border-purple-200"><span>Total</span><span>${formatCurrency(total)}</span></div>
              </div>

              <form onsubmit="sendToWhatsApp(event)" class="space-y-4">
                <input type="text" name="name" placeholder="Nama Lengkap" required class="w-full p-4 border rounded-xl outline-none focus:border-purple-600">
                <textarea name="address" placeholder="Alamat Detail (No. Rumah / Patokan)" required class="w-full p-4 border rounded-xl outline-none h-24 focus:border-purple-600"></textarea>
                <button type="submit" class="whatsapp-btn w-full py-4 text-white font-bold rounded-2xl shadow-lg">Pesan Sekarang</button>
              </form>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Jalankan aplikasi
    window.onload = loadProducts;
  </script>
</body>
</html>
