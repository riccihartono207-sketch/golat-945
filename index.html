<!DOCTYPE html>
<html lang="id" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Goklat 945 - Order Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap");

      * {
        font-family: "Poppins", sans-serif;
        box-sizing: border-box;
      }

      /* Animasi Floating untuk Emoji saat Tutup */
      .floating {
        animation: floating 3s ease-in-out infinite;
      }
      @keyframes floating {
        0% { transform: translate(0, 0px); }
        50% { transform: translate(0, 15px); }
        100% { transform: translate(0, -0px); }
      }

      /* Background Pattern saat Tutup */
      .bg-pattern {
        background-color: #f3e8ff;
        background-image: radial-gradient(#d8b4fe 1px, transparent 1px);
        background-size: 20px 20px;
      }

      .product-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
      }
      .product-card:hover:not(.disabled) {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      }

      .whatsapp-btn {
        background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);
        transition: all 0.3s ease;
      }
      .whatsapp-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(37, 211, 102, 0.4);
      }

      .category-content {
        max-height: 0;
        opacity: 0;
        visibility: hidden;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
          opacity 0.3s ease, padding 0.3s ease, visibility 0.4s;
        padding-top: 0 !important;
        padding-bottom: 0 !important;
      }

      .category-content.open {
        max-height: 5000px;
        opacity: 1;
        visibility: visible;
        padding-top: 1rem !important;
        padding-bottom: 1rem !important;
      }

      .rotate-icon {
        transition: transform 0.3s ease;
      }
      .rotate-icon.open {
        transform: rotate(180deg);
      }

      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #5b21b6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="h-full w-full overflow-auto bg-gray-100" id="body-main">
    <div id="app" class="w-full min-h-full">
      <div class="flex flex-col items-center justify-center h-screen">
        <div class="loader mb-4"></div>
        <p class="text-purple-900 font-semibold text-center px-4">
          Memuat Menu Goklat...
        </p>
      </div>
    </div>

    <script>
      // ============================================================
      // PENGATURAN TUTUP MENDADAK
      // Ganti ke 'true' jika ingin menutup toko secara paksa.
      // Ganti ke 'false' untuk mengikuti jadwal normal.
      const tutupMendadak = true; 
      // ============================================================

      const config = {
        store_title: "Goklat 945",
        store_address: "Batang Ayumi Julu, Padang Sidempuan Utara",
        whatsapp_number: "6282277647548",
        primary_color: "#5b21b6",
        opening_hours_text: "Senin - Jumat | 09.00 - 17.00",
        op_days: [1, 2, 3, 4, 5],
        op_start: 9,
        op_end: 17,
      };

      const DATA_URL = "Products.json";

      const locationData = {
        "Padangsidimpuan Utara": { "Batang Ayumi Julu": 2000, "Batang Ayumi Jae": 2000, Baringin: 3000, "Bonan Dolok": 3000, Kantor: 3000, "Losung Batu": 3000, "Pancuran Gerobak": 3000, Sadabuan: 5000, Sibatua: 5000, Timbangan: 5000, "Wek I": 3000, "Wek II": 3000, "Wek III": 3000, "Wek IV": 3000 },
        "Padangsidimpuan Selatan": { "Aek Tampang": 5000, Hanopan: 5000, Losung: 5000, "Padang Matinggi": 5000, "Padang Matinggi Lestari": 5000, Sidangkal: 5000, Sihitang: 8000, Sitinjak: 8000, "Ujung Padang": 5000, "Wek V": 3000, "Wek VI": 3000 },
        "Padangsidimpuan Tenggara": { "Labuhan Labo": 8000, "Labuhan Rasoki": 10000, "Manunggang Jae": 8000, "Manunggang Julu": 8000, "Palopat Maria": 8000, "Purbatua Pijor Koling": 10000, "Sihitang Jae": 8000, "Pijor Koling": 10000 },
        "Padangsidimpuan Batunadua": { "Batunadua Jae": 8000, "Batunadua Julu": 8000, "Batu Gajah": 8000, "Pudun Jae": 8000, "Pudun Julu": 8000, Siloting: 10000, Simirik: 8000, "Ujung Gurap": 8000 },
        "Padangsidimpuan Hutaimbaru": { Hutaimbaru: 8000, "Lembah Lubuk Raya": 10000, "Sabungan Sipabangun": 10000, Singali: 10000, Talippung: 10000 },
        "Padangsidimpuan Angkola Julu": { Batuayan: 12000, "Joring Lombang": 12000, "Joring Natobang": 12000, Mombang: 12000, "Pintu Langit Jae": 12000, Simasom: 12000 }
      };

      let categories = {};
      let cart = [];
      let openCategories = {};
      let selectedKecamatan = "";
      let selectedKelurahan = "";
      let currentShippingFee = 0;

      function isStoreOpen() {
        if (tutupMendadak) return false;
        const now = new Date();
        const day = now.getDay();
        const hour = now.getHours();
        return config.op_days.includes(day) && hour >= config.op_start && hour < config.op_end;
      }

      async function loadProducts() {
        if (!isStoreOpen()) {
          renderClosedState();
          return;
        }

        const timestamp = new Date().getTime();
        try {
          const response = await fetch(`${DATA_URL}?v=${timestamp}`);
          if (!response.ok) throw new Error(`Status: ${response.status}`);
          const data = await response.json();
          categories = data;
          Object.keys(categories).forEach((key) => {
            if (openCategories[key] === undefined) openCategories[key] = false;
          });
          renderApp();
        } catch (error) {
          document.getElementById("app").innerHTML = `<div class="p-10 text-center text-red-600 font-bold">${error.message}</div>`;
        }
      }

      function renderClosedState() {
        // Ganti background body jadi pattern ungu ceria
        document.getElementById('body-main').className = "bg-pattern h-full flex items-center justify-center p-6";
        
        document.getElementById("app").innerHTML = `
          <div class="max-w-md w-full bg-white rounded-[3rem] shadow-2xl overflow-hidden border-4 border-purple-200 animate-in fade-in zoom-in duration-500">
            <div class="p-8 text-center">
              <!-- Area Gambar Kartun/Emoji -->
              <div class="relative py-10 flex justify-center">
                <div class="floating text-9xl">ü•§</div>
                <div class="absolute top-10 right-10 text-5xl">üí§</div>
                <div class="absolute bottom-10 left-10 text-4xl transform -rotate-12">üç´</div>
              </div>

              <!-- Pesan Penutup -->
              <div class="space-y-4">
                <h1 class="text-3xl font-extrabold text-purple-900 leading-tight tracking-tighter uppercase">
                  PENGUMUMAN
                </h1>

                <div class="bg-purple-50 rounded-2xl p-6 border-2 border-dashed border-purple-300">
                  <p class="text-lg text-purple-800 font-semibold leading-relaxed italic">
                    "Maaf hari ini Tokoh Goklat 945 tutup di Jadwal buka, terimakasih atas kunjungannya"
                  </p>
                </div>

                <p class="text-gray-500 text-sm font-medium">
                  Sampai jumpa di hari berikutnya! Kami akan segera kembali melayani pesanan Anda dengan penuh rasa coklat.
                </p>
              </div>

              <!-- Dekorasi -->
              <div class="flex justify-center gap-2 mt-8">
                <div class="w-3 h-3 rounded-full bg-purple-600"></div>
                <div class="w-3 h-3 rounded-full bg-purple-400"></div>
                <div class="w-3 h-3 rounded-full bg-purple-200"></div>
              </div>
            </div>

            <div class="bg-purple-900 py-4 text-center">
              <p class="text-white text-xs font-bold tracking-widest uppercase">
                ${config.store_title} - Padang Sidempuan
              </p>
            </div>
          </div>
        `;
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(amount);
      }

      function toggleCategory(key) {
        openCategories[key] = !openCategories[key];
        renderApp();
      }

      function addToCart(pid) {
        let product = null;
        for (let k in categories) {
          let found = categories[k].products.find((p) => p.id === pid);
          if (found) { product = found; break; }
        }
        if (!product || product.outOfStock) return;
        const item = cart.find((i) => i.id === pid);
        if (item) item.qty++;
        else cart.push({ ...product, qty: 1 });
        renderApp();
      }

      function updateQty(pid, delta) {
        const item = cart.find((i) => i.id === pid);
        if (item) {
          item.qty += delta;
          if (item.qty <= 0) cart = cart.filter((i) => i.id !== pid);
        }
        renderApp();
      }

      function handleLocationChange(kec, kel) {
        selectedKecamatan = kec;
        selectedKelurahan = kel;
        currentShippingFee = kec && kel ? locationData[kec][kel] : 0;
        renderApp();
      }

      function generateOrderID() {
        const now = new Date();
        return `GK-${now.getFullYear()}${(now.getMonth() + 1)}${now.getDate()}-${now.getHours()}${now.getMinutes()}`;
      }

      function sendToWhatsApp(e) {
        e.preventDefault();
        const f = e.target;
        const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
        const total = subtotal + currentShippingFee;
        let msg = `*PESANAN BARU - ${config.store_title}*\nüÜî *ID:* ${generateOrderID()}\n\n*Item:*\n`;
        cart.forEach((i) => (msg += `‚Ä¢ ${i.name} (x${i.qty}) - ${formatCurrency(i.price * i.qty)}\n`));
        msg += `\nSubtotal: ${formatCurrency(subtotal)}\nOngkir: ${formatCurrency(currentShippingFee)}\n*Total: ${formatCurrency(total)}*\n\n*Data:* ${f.name.value} (${f.phone.value})\n*Alamat:* ${selectedKelurahan}, ${selectedKecamatan}\n${f.address.value}`;
        window.open(`https://wa.me/${config.whatsapp_number}?text=${encodeURIComponent(msg)}`, "_blank");
      }

      function renderApp() {
        const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
        const total = subtotal + currentShippingFee;

        document.getElementById("app").innerHTML = `
        <div class="max-w-4xl mx-auto px-4 py-8">
          <header class="text-center mb-10">
            <div class="inline-block bg-purple-100 text-purple-700 px-4 py-1 rounded-full text-xs font-bold mb-3 tracking-wide uppercase">
              üïí Buka: ${config.opening_hours_text}
            </div>
            <h1 class="text-4xl font-extrabold text-purple-900 mb-2">${config.store_title}</h1>
            <p class="text-gray-600 text-sm">${config.store_address}</p>
          </header>

          <div class="space-y-6">
            ${Object.keys(categories).map((key) => {
                const cat = categories[key];
                const isOpen = openCategories[key];
                const availableProducts = cat.products.filter((p) => !p.outOfStock);
                if (availableProducts.length === 0) return "";
                return `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                  <div onclick="toggleCategory('${key}')" class="p-5 bg-purple-50 flex justify-between items-center cursor-pointer hover:bg-purple-100 transition relative z-20">
                    <div class="flex items-center gap-3">
                      <span class="text-2xl">${cat.icon || "ü•§"}</span>
                      <div>
                        <h2 class="text-xl font-bold text-purple-900 leading-tight">${cat.name}</h2>
                        <span class="text-[10px] font-bold bg-purple-200 text-purple-800 px-2 py-0.5 rounded-full uppercase tracking-wider italic">
                          ${availableProducts.length} Menu Tersedia
                        </span>
                      </div>
                    </div>
                    <svg class="rotate-icon ${isOpen ? "open" : ""}" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
                  </div>
                  <div class="category-content ${isOpen ? "open" : ""} px-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${availableProducts.map((p) => {
                        const inCart = cart.find((i) => i.id === p.id);
                        return `
                        <div class="product-card border rounded-xl p-3 text-center bg-white">
                          <div class="w-full h-32 overflow-hidden rounded-lg mb-2 flex items-center justify-center bg-gray-50">
                            <img src="${p.image}" class="max-h-full max-w-full object-contain" onerror="this.src='https://placehold.co/200x200/5b21b6/ffffff?text=Menu'">
                          </div>
                          <h3 class="text-xs font-bold h-8 overflow-hidden mb-1 text-gray-800 uppercase">${p.name}</h3>
                          <p class="text-purple-700 font-bold text-sm mb-3">${formatCurrency(p.price)}</p>
                          ${inCart ? `<div class="flex items-center justify-between bg-purple-100 rounded-lg p-1">
                                <button onclick="updateQty(${p.id}, -1)" class="w-7 h-7 bg-purple-600 text-white rounded-md font-bold shadow-sm hover:bg-purple-700 transition">-</button>
                                <span class="font-bold text-purple-900">${inCart.qty}</span>
                                <button onclick="updateQty(${p.id}, 1)" class="w-7 h-7 bg-purple-600 text-white rounded-md font-bold shadow-sm hover:bg-purple-700 transition">+</button>
                              </div>` : `<button onclick="addToCart(${p.id})" class="w-full py-2 bg-purple-600 text-white rounded-lg text-xs font-bold shadow-md hover:bg-purple-700 transition">Tambah</button>`}
                        </div>`;
                      }).join("")}
                  </div>
                </div>`;
              }).join("")}
          </div>

          ${cart.length > 0 ? `
            <div class="mt-10 bg-white p-6 rounded-3xl shadow-xl border-t-4 border-purple-600">
              <h3 class="text-xl font-bold mb-6 flex items-center gap-2">üõí <span>Checkout</span></h3>
              <form onsubmit="sendToWhatsApp(event)" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <input type="text" name="name" placeholder="Nama Lengkap" required class="w-full p-3 border border-gray-200 rounded-xl outline-none focus:border-purple-600 bg-gray-50">
                  <input type="tel" name="phone" placeholder="No. WhatsApp" required class="w-full p-3 border border-gray-200 rounded-xl outline-none focus:border-purple-600 bg-gray-50">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <select onchange="handleLocationChange(this.value, '')" required class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 outline-none focus:border-purple-600 transition">
                      <option value="">-- Pilih Kecamatan --</option>
                      ${Object.keys(locationData).map((k) => `<option value="${k}" ${selectedKecamatan === k ? "selected" : ""}>${k}</option>`).join("")}
                    </select>
                    <select onchange="handleLocationChange(selectedKecamatan, this.value)" ${!selectedKecamatan ? "disabled" : ""} required class="w-full p-3 border border-gray-200 rounded-xl bg-gray-50 outline-none focus:border-purple-600 transition disabled:opacity-50">
                      <option value="">-- Pilih Kelurahan --</option>
                      ${selectedKecamatan ? Object.keys(locationData[selectedKecamatan]).map((kel) => `<option value="${kel}" ${selectedKelurahan === kel ? "selected" : ""}>${kel}</option>`).join("") : ""}
                    </select>
                </div>
                <textarea name="address" placeholder="Alamat Lengkap & Patokan" required class="w-full p-3 border border-gray-200 rounded-xl outline-none h-24 focus:border-purple-600 bg-gray-50 resize-none"></textarea>

                <div class="bg-purple-900 p-5 rounded-2xl text-white shadow-inner">
                  <div class="flex justify-between text-xs text-purple-200 mb-1"><span>Subtotal Produk</span><span>${formatCurrency(subtotal)}</span></div>
                  <div class="flex justify-between text-xs text-purple-200 mb-4 pb-4 border-b border-purple-800"><span>Ongkir</span><span>${formatCurrency(currentShippingFee)}</span></div>
                  <div class="flex justify-between font-bold text-xl items-center"><span>Total Bayar</span><span class="text-yellow-400">${formatCurrency(total)}</span></div>
                </div>

                <button type="submit" class="whatsapp-btn w-full py-4 text-white font-bold rounded-2xl shadow-lg text-lg flex items-center justify-center gap-3">Kirim Pesanan Sekarang</button>
              </form>
            </div>` : `<div class="mt-10 p-10 text-center border-2 border-dashed border-gray-300 rounded-3xl text-gray-400">Belum ada item yang dipilih</div>`}
          
          <footer class="mt-12 text-center text-gray-400 text-xs">
            &copy; 2026 ${config.store_title} - Digital Ordering System
          </footer>
        </div>`;
      }

      window.onload = loadProducts;
    </script>
  </body>
</html>
